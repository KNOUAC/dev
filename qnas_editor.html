<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë¬¸ì œ ì—ë””í„° v5.4 (íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¶”ê°€)</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; line-height: 1.6; padding: 20px; background: #f0f2f5; }
        .container { max-width: 950px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 10px; color: #333; }
        
        .config-bar { background: #343a40; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; font-size: 0.85em; }
        .config-bar input { width: 180px; padding: 5px 10px; border-radius: 4px; border: none; }
        
        .top-bar { background: #e7f1ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        textarea { height: 100px; font-family: 'Consolas', monospace; }

        .img-upload-group { display: flex; gap: 5px; }
        .btn-upload { background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; white-space: nowrap; font-size: 0.8em; }
        
        .btn-group { margin-top: 30px; display: flex; gap: 10px; justify-content: center; }
        button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.2s; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-save { background: #28a745; color: white; }
        .btn-save:hover { background: #218838; }
        
        .btn-json { background: #007bff; color: white; }
        .btn-json:hover { background: #0069d9; }
        
        /* âœ… ì¶”ê°€ëœ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ë³´ë¼ìƒ‰ ê³„ì—´) */
        .btn-download { background: #6610f2; color: white; }
        .btn-download:hover { background: #520dc2; }

        .btn-clear { background: #6c757d; color: white; }
        .btn-clear:hover { background: #5a6268; }
        
        #json-output { margin-top: 25px; background: #2d2d2d; color: #ccc; padding: 20px; border-radius: 8px; white-space: pre-wrap; font-family: 'Consolas', monospace; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ§© ë¬¸ì œ ë°ì´í„° ì—ë””í„° v5.4</h2>
    
    <div class="config-bar">
        <span>ğŸ”‘ GitHub Token:</span> <input type="password" id="gh-token" placeholder="ghp_xxx...">
        <span>ğŸ“‚ Repo:</span> <input type="text" id="gh-repo" placeholder="ì•„ì´ë””/ì €ì¥ì†Œëª…">
        <span style="color: #ffc107; font-size: 0.9em;">* ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ì‚¬ìš©ë©ë‹ˆë‹¤.</span>
    </div>

    <div class="top-bar">
        <button onclick="document.getElementById('file-input').click()" style="background:#6f42c1; color:white;">JSON ë¡œë“œ</button>
        <input type="file" id="file-input" accept=".json" style="display:none" onchange="loadJSONFile(event)">
        
        <label>ğŸ“ ìˆ˜ì • ë¬¸í•­:</label>
        <select id="edit-selector" onchange="fillForm(this.value)" style="width: auto; min-width: 250px;">
            <option value="">-- ë¬¸í•­ ì„ íƒ --</option>
        </select>
    </div>

    <div class="form-grid">
        <div class="form-group"><label>ë¬¸í•­ ë²ˆí˜¸ (ID)</label><input type="number" id="inp-id"></div>
        <div class="form-group"><label>ì°¸ì¡° ì•ˆë‚´ë¬¸</label><input type="text" id="inp-ref"></div>
        
        <div class="form-group">
            <label>ìƒë‹¨ ì´ë¯¸ì§€ (imgTop)</label>
            <div class="img-upload-group">
                <input type="text" id="inp-imgTop" placeholder="./image.png">
                <button class="btn-upload" onclick="triggerUpload('inp-imgTop')">ì—…ë¡œë“œ</button>
            </div>
        </div>
        <div class="form-group">
            <label>í•˜ë‹¨ ì´ë¯¸ì§€ (imgBottom)</label>
            <div class="img-upload-group">
                <input type="text" id="inp-imgBottom" placeholder="./image.png">
                <button class="btn-upload" onclick="triggerUpload('inp-imgBottom')">ì—…ë¡œë“œ</button>
            </div>
        </div>

        <div class="form-group full-width"><label>ì§ˆë¬¸ (Question)</label><input type="text" id="inp-q"></div>

        <div class="form-group full-width">
            <label>ìƒë‹¨ ì§€ë¬¸ (Passage Top)</label>
            <textarea id="inp-pTop" placeholder="ì§ˆë¬¸ ìœ„, ì´ë¯¸ì§€ ì•„ë˜ì— í‘œì‹œë©ë‹ˆë‹¤. (ê¸°ì¡´ passage)"></textarea>
        </div>
        <div class="form-group full-width">
            <label>í•˜ë‹¨ ì§€ë¬¸ (Passage Bottom)</label>
            <textarea id="inp-pBottom" placeholder="ì§ˆë¬¸ ì•„ë˜, ë³´ê¸° ìœ„ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>
        </div>

        <div class="full-width">
            <div class="form-grid" style="background:#f8f9fa; padding:15px; border-radius:8px;">
                <input type="text" class="opt" placeholder="ë³´ê¸° 1">
                <input type="text" class="opt" placeholder="ë³´ê¸° 2">
                <input type="text" class="opt" placeholder="ë³´ê¸° 3">
                <input type="text" class="opt" placeholder="ë³´ê¸° 4">
                <select id="inp-ans"><option value="0">1ë²ˆ ì •ë‹µ</option><option value="1">2ë²ˆ ì •ë‹µ</option><option value="2">3ë²ˆ ì •ë‹µ</option><option value="3">4ë²ˆ ì •ë‹µ</option></select>
            </div>
        </div>

        <div class="form-group full-width">
            <label>í•´ì„¤ ì´ë¯¸ì§€ (explanationImg)</label>
            <div class="img-upload-group" style="width: 50%;">
                <input type="text" id="inp-expImg">
                <button class="btn-upload" onclick="triggerUpload('inp-expImg')">ì—…ë¡œë“œ</button>
            </div>
            <label style="margin-top:10px;">í•´ì„¤ í…ìŠ¤íŠ¸</label>
            <textarea id="inp-exp" style="height: 60px;"></textarea>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-save" onclick="addItem()">ë¬¸í•­ ì €ì¥</button>
        <button class="btn-json" onclick="exportJSON()">ì „ì²´ JSON ë³µì‚¬</button>
        <button class="btn-download" onclick="downloadJSONFile()">JSON íŒŒì¼ ì €ì¥</button>
        <button class="btn-clear" onclick="resetForm()">ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”</button>
    </div>

    <div id="json-output">// ê²°ê³¼ JSON</div>
    
    <input type="file" id="gh-upload-input" style="display:none" onchange="handleGithubUpload(event)">
</div>

<script>
    let db = [];
    let currentTargetId = '';

    function triggerUpload(targetId) {
        currentTargetId = targetId;
        document.getElementById('gh-upload-input').click();
    }

    async function handleGithubUpload(event) {
        const file = event.target.files[0];
        const token = document.getElementById('gh-token').value;
        const repo = document.getElementById('gh-repo').value;
    
        if (!file || !token || !repo) {
            alert("GitHub í† í°ê³¼ ì €ì¥ì†Œ ì •ë³´ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
    
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const base64Content = reader.result.split(',')[1];
            const fileName = file.name;
            const url = `https://api.github.com/repos/${repo}/contents/images/${fileName}`;
            let sha = null;
    
            try {
                const checkRes = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
                if (checkRes.ok) {
                    const fileData = await checkRes.json();
                    sha = fileData.sha;
                    if (!confirm(`ì´ë¯¸ ë™ì¼í•œ íŒŒì¼ëª…('${fileName}')ì´ ì¡´ì¬í•©ë‹ˆë‹¤.\në®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        event.target.value = ''; return;
                    }
                }
                
                const payload = {
                    message: sha ? `Update ${fileName}` : `Upload ${fileName}`,
                    content: base64Content
                };
                if (sha) payload.sha = sha;
    
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
    
                if (response.ok) {
                    document.getElementById(currentTargetId).value = `./images/${fileName}`;
                    alert(sha ? "ì—…ë°ì´íŠ¸ ì™„ë£Œ!" : "ì—…ë¡œë“œ ì„±ê³µ!");
                } else {
                    const error = await response.json();
                    alert("ì‹¤íŒ¨: " + error.message);
                }
            } catch (err) { alert("ì˜¤ë¥˜: " + err.message); } 
            finally { event.target.value = ''; }
        };
    }

    function loadJSONFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                db = JSON.parse(e.target.result);
                updateSelector(); updateDisplay();
                alert("ë°ì´í„° ë¡œë“œ ì™„ë£Œ");
            } catch (err) { alert("JSON í˜•ì‹ ì˜¤ë¥˜!"); }
            finally { event.target.value = ''; }
        };
        reader.readAsText(file);
    }

    function updateSelector() {
        const selector = document.getElementById('edit-selector');
        selector.innerHTML = '<option value="">-- ë¬¸í•­ ì„ íƒ --</option>';
        db.sort((a,b) => a.id - b.id).forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.id;
            opt.innerText = `ID ${item.id}: ${item.question.substring(0,15)}...`;
            selector.appendChild(opt);
        });
    }

    function fillForm(selectedId) {
        if (!selectedId) { resetForm(false); return; } 
        const item = db.find(x => x.id == selectedId);
        if (!item) return;
        document.getElementById('inp-id').value = item.id;
        document.getElementById('inp-ref').value = item.refInstruction || "";
        document.getElementById('inp-imgTop').value = item.imgTop || "";
        document.getElementById('inp-imgBottom').value = item.imgBottom || "";
        document.getElementById('inp-q').value = item.question || "";
        
        document.getElementById('inp-pTop').value = item.passageTop || item.passage || "";
        document.getElementById('inp-pBottom').value = item.passageBottom || "";
        
        document.getElementById('inp-ans').value = item.answer;
        document.getElementById('inp-expImg').value = item.explanationImg || "";
        document.getElementById('inp-exp').value = item.explanation || "";
        const opts = document.querySelectorAll('.opt');
        item.options.forEach((val, idx) => { if (opts[idx]) opts[idx].value = val; });
    }

    function addItem() {
        const idVal = document.getElementById('inp-id').value;
        const item = {
            id: parseInt(idVal),
            refInstruction: document.getElementById('inp-ref').value || undefined,
            imgTop: document.getElementById('inp-imgTop').value || undefined,
            imgBottom: document.getElementById('inp-imgBottom').value || undefined,
            
            passageTop: document.getElementById('inp-pTop').value || undefined,
            passageBottom: document.getElementById('inp-pBottom').value || undefined,
            
            question: document.getElementById('inp-q').value,
            options: Array.from(document.querySelectorAll('.opt')).map(i => i.value),
            answer: parseInt(document.getElementById('inp-ans').value),
            explanationImg: document.getElementById('inp-expImg').value || undefined,
            explanation: document.getElementById('inp-exp').value || ""
        };
        
        Object.keys(item).forEach(key => (item[key] === undefined || item[key] === "") && delete item[key]);
        
        const idx = db.findIndex(x => x.id === item.id);
        if(idx > -1) db[idx] = item; else db.push(item);
        
        updateSelector(); updateDisplay();
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function resetForm(askConfirm = true) {
        if(askConfirm && !confirm("ëª¨ë“  ì…ë ¥ë€ì„ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const ids = ['inp-id', 'inp-ref', 'inp-imgTop', 'inp-imgBottom', 'inp-q', 'inp-pTop', 'inp-pBottom', 'inp-expImg', 'inp-exp'];
        ids.forEach(id => document.getElementById(id).value = '');
        document.querySelectorAll('.opt').forEach(opt => opt.value = '');
        document.getElementById('inp-ans').value = 0;
        document.getElementById('edit-selector').value = ""; 
    }

    // âœ… ì¶”ê°€ëœ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
    function downloadJSONFile() {
        if (db.length === 0) {
            alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        // JSON ë¬¸ìì—´ ìƒì„±
        const dataStr = JSON.stringify(db, null, 4);
        
        // Blob ê°ì²´ ìƒì„±
        const blob = new Blob([dataStr], {type: "application/json"});
        
        // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„± ë° í´ë¦­ íŠ¸ë¦¬ê±°
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "qnas.json"; // ì €ì¥ë  íŒŒì¼ëª…
        document.body.appendChild(a);
        a.click();
        
        // ë’·ì •ë¦¬
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function updateDisplay() { document.getElementById('json-output').innerText = JSON.stringify(db, null, 4); }
    function exportJSON() {
        navigator.clipboard.writeText(JSON.stringify(db, null, 4)).then(() => alert("ì „ì²´ JSONì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"));
    }
</script>

</body>
</html>
