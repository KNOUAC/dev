<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiz Editor v6.6 (Random Pattern Lock)</title>
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) --- */
        body { font-family: 'Pretendard', 'Malgun Gothic', sans-serif; line-height: 1.6; background: #f0f2f5; margin: 0; padding: 0; color: #333; -webkit-font-smoothing: antialiased; overflow-x: hidden; }
        * { box-sizing: border-box; }
        
        /* --- ë ˆì´ì•„ì›ƒ --- */
        #main-app { display: none; opacity: 0; transition: opacity 0.5s ease; padding: 15px; }
        .container { max-width: 950px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 12px; margin-top: 0; color: #333; font-size: 1.5rem; }

        /* --- ì…ë ¥ í•„ë“œ --- */
        label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.95em; color: #444; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.2s; background: #fff; }
        input:focus, textarea:focus, select:focus { border-color: #007bff; outline: none; }
        textarea { min-height: 100px; font-family: 'Consolas', monospace; resize: vertical; }

        /* --- UI ì»´í¬ë„ŒíŠ¸ --- */
        .config-bar { background: #343a40; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 12px; align-items: center; font-size: 0.9em; }
        .config-bar input { width: auto; flex-grow: 1; min-width: 150px; border: none; background: #4b545c; color: white; }
        .top-bar { background: #e7f1ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .full-width { grid-column: span 2; }
        .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .img-upload-group { display: flex; gap: 8px; width: 100%; }
        .img-upload-group input { flex-grow: 1; }
        .btn-upload { background: #17a2b8; color: white; border: none; padding: 0 15px; border-radius: 6px; cursor: pointer; white-space: nowrap; font-weight: 600; }
        .btn-group { margin-top: 30px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        button { padding: 14px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; transition: 0.2s; }
        .btn-save { background: #28a745; color: white; }
        .btn-json { background: #007bff; color: white; }
        .btn-download { background: #6610f2; color: white; }
        .btn-clear { background: #6c757d; color: white; }
        #json-output { margin-top: 25px; background: #2d2d2d; color: #ccc; padding: 15px; border-radius: 8px; white-space: pre-wrap; font-family: 'Consolas', monospace; max-height: 200px; overflow-y: auto; font-size: 0.85em; }

        /* --- ğŸ”’ ì ê¸ˆ í™”ë©´ --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f0f2f5; display: flex; justify-content: center; align-items: center;
            z-index: 9999; padding: 20px;
        }
        .login-card {
            background: white; padding: 40px 30px; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; width: 100%; max-width: 360px;
            animation: fadeIn 0.5s ease-out; position: relative;
        }
        .login-icon { font-size: 45px; margin-bottom: 15px; display: block; }
        .login-title { font-size: 1.4rem; font-weight: 800; color: #333; margin-bottom: 25px; }
        .btn-login { width: 100%; padding: 14px; border: none; border-radius: 8px; background: #007bff; color: white; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .fail-msg { color: #dc3545; font-size: 0.85em; margin-top: 10px; display: none; font-weight: bold; }

        /* --- ğŸŒŠ íŒ¨í„´ ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ --- */
        #puzzle-area { display: none; margin-top: 20px; }
        .wave-container {
            position: relative; width: 100%; height: 80px; 
            background: #f8f9fa; border-radius: 12px; border: 1px solid #e1e4e8;
            overflow: hidden; touch-action: none;
        }
        .wave-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .wave-path { fill: none; stroke: #d1d5db; stroke-width: 4px; stroke-linecap: round; stroke-linejoin: round; }
        .wave-knob {
            position: absolute; width: 44px; height: 44px;
            background: #007bff; border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            cursor: grab; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 20px; z-index: 10;
            top: 50%; left: 0; /* JS ì œì–´ */
            transform: translate(0, -50%);
        }
        .wave-knob:active { cursor: grabbing; background: #0056b3; }
        .puzzle-text { font-size: 0.9em; color: #666; margin-bottom: 10px; font-weight: bold; }

        @media (max-width: 768px) {
            .container { padding: 15px; width: 100%; border-radius: 0; box-shadow: none; }
            #main-app { padding: 0; }
            .form-grid, .opt-grid, .btn-group { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
            .btn-group { grid-template-columns: 1fr 1fr; }
            .config-bar span.note { display: none; }
            .img-upload-group { flex-direction: row; }
            .form-group .img-upload-group[style*="width: 50%"] { width: 100% !important; }
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
        .shake { animation: shake 0.3s; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-card" id="login-card">
        <span class="login-icon">ğŸ”’</span>
        <div class="login-title" id="login-title">ê´€ë¦¬ì ì ‘ì†</div>
        
        <div id="login-form-area">
            <input type="password" id="password-input" placeholder="ë¹„ë°€ë²ˆí˜¸" style="text-align:center; margin-bottom:15px;" onkeypress="handleEnter(event)">
            <button class="btn-login" onclick="checkPassword()">í™•ì¸</button>
            <div id="fail-msg" class="fail-msg"></div>
        </div>

        <div id="puzzle-area">
            <div class="puzzle-text" id="puzzle-text">ê¸¸ì„ ë”°ë¼ ëê¹Œì§€ ë¯¸ì„¸ìš”</div>
            <div class="wave-container" id="wave-container">
                <svg class="wave-svg">
                    <path id="wave-path" class="wave-path"></path>
                </svg>
                <div class="wave-knob" id="wave-knob">ğŸ”“</div>
            </div>
            <div style="font-size:0.8em; color:#888; margin-top:10px;">ë„ˆë¬´ ë§ì€ ì‹œë„ ì‹¤íŒ¨</div>
        </div>
    </div>
</div>

<div id="main-app">
    <div class="container">
        <h2>ğŸ§© Quiz Editor v6.6</h2>
        <div class="config-bar">
            <span>ğŸ”‘ GitHub:</span> <input type="password" id="gh-token" placeholder="Token">
            <span>ğŸ“‚ Repo:</span> <input type="text" id="gh-repo" placeholder="User/Repo">
        </div>
        <div class="top-bar">
            <button onclick="document.getElementById('file-input').click()" style="background:#6f42c1; color:white; padding:10px 15px;">JSON ë¡œë“œ</button>
            <input type="file" id="file-input" accept=".json" style="display:none" onchange="loadJSONFile(event)">
            <select id="edit-selector" onchange="fillForm(this.value)"><option value="">-- ìˆ˜ì •í•  ë¬¸í•­ ì„ íƒ --</option></select>
        </div>
        <div class="form-grid">
            <div class="form-group"><label>ID</label><input type="number" id="inp-id"></div>
            <div class="form-group"><label>ì°¸ì¡° ì•ˆë‚´ë¬¸</label><input type="text" id="inp-ref"></div>
            <div class="form-group"><label>ìƒë‹¨ ì´ë¯¸ì§€</label><div class="img-upload-group"><input type="text" id="inp-imgTop"><button class="btn-upload" onclick="triggerUpload('inp-imgTop')">UP</button></div></div>
            <div class="form-group"><label>í•˜ë‹¨ ì´ë¯¸ì§€</label><div class="img-upload-group"><input type="text" id="inp-imgBottom"><button class="btn-upload" onclick="triggerUpload('inp-imgBottom')">UP</button></div></div>
            <div class="full-width"><label>ì§ˆë¬¸</label><input type="text" id="inp-q"></div>
            <div class="full-width"><label>ìƒë‹¨ ì§€ë¬¸</label><textarea id="inp-pTop"></textarea></div>
            <div class="full-width"><label>í•˜ë‹¨ ì§€ë¬¸</label><textarea id="inp-pBottom"></textarea></div>
            <div class="full-width">
                <label>ë³´ê¸°/ì •ë‹µ</label>
                <div class="opt-grid">
                    <input type="text" class="opt" placeholder="1"><input type="text" class="opt" placeholder="2">
                    <input type="text" class="opt" placeholder="3"><input type="text" class="opt" placeholder="4">
                </div>
                <select id="inp-ans" style="margin-top:10px;"><option value="0">ì •ë‹µ 1</option><option value="1">ì •ë‹µ 2</option><option value="2">ì •ë‹µ 3</option><option value="3">ì •ë‹µ 4</option></select>
            </div>
            <div class="full-width"><label>í•´ì„¤</label><div class="img-upload-group" style="width:50%; margin-bottom:5px;"><input type="text" id="inp-expImg"><button class="btn-upload" onclick="triggerUpload('inp-expImg')">UP</button></div><textarea id="inp-exp" style="height:60px;"></textarea></div>
        </div>
        <div class="btn-group">
            <button class="btn-save" onclick="addItem()">ì €ì¥</button>
            <button class="btn-download" onclick="downloadJSONFile()">íŒŒì¼ ì €ì¥</button>
            <button class="btn-json" onclick="exportJSON()">JSON ë³µì‚¬</button>
            <button class="btn-clear" onclick="resetForm()">ì´ˆê¸°í™”</button>
        </div>
        <div id="json-output"></div>
        <input type="file" id="gh-upload-input" style="display:none" onchange="handleGithubUpload(event)">
    </div>
</div>

<script>
    /* -----------------------------------------------------------
       ğŸ” 1. ë³´ì•ˆ ë° ëœë¤ íŒ¨í„´ ìŠ¬ë¼ì´ë” ë¡œì§
    ----------------------------------------------------------- */
    const ACCESS_PASSWORD = "0070#";
    let failCount = 0;
    const MAX_FAIL = 5;

    // íŒ¨í„´ ê´€ë ¨ ë³€ìˆ˜
    const waveContainer = document.getElementById('wave-container');
    const waveKnob = document.getElementById('wave-knob');
    const wavePath = document.getElementById('wave-path');
    let isDragging = false;
    let currentPattern = 'sine'; // 'sine' or 'zigzag'

    // ë¹„ë°€ë²ˆí˜¸ ì²´í¬
    function checkPassword() {
        const input = document.getElementById('password-input');
        const overlay = document.getElementById('login-overlay');
        const app = document.getElementById('main-app');
        const card = document.getElementById('login-card');
        const failMsg = document.getElementById('fail-msg');

        if (input.value === ACCESS_PASSWORD) {
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
                app.style.display = 'block';
                setTimeout(() => { app.style.opacity = '1'; }, 50);
            }, 300);
        } else {
            failCount++;
            card.classList.add('shake');
            input.style.borderColor = '#dc3545';
            failMsg.style.display = 'block';
            failMsg.innerText = `í‹€ë¦¼ (${failCount}/${MAX_FAIL})`;

            if (failCount >= MAX_FAIL) {
                document.getElementById('login-form-area').style.display = 'none';
                document.getElementById('puzzle-area').style.display = 'block';
                document.getElementById('login-title').innerText = "ë³´ì•ˆ ì ê¸ˆ";
                initWaveSlider(); // ëœë¤ íŒ¨í„´ ìƒì„±
            }

            setTimeout(() => {
                card.classList.remove('shake');
                input.style.borderColor = '#ddd';
                input.value = '';
                if(failCount < MAX_FAIL) input.focus();
            }, 300);
        }
    }
    function handleEnter(e) { if (e.key === 'Enter') checkPassword(); }

    // --- ğŸ² ëœë¤ íŒ¨í„´ ìƒì„± ë° ë“œë˜ê·¸ ---
    function initWaveSlider() {
        // ëœë¤ íŒ¨í„´ ì„ íƒ (50% í™•ë¥ )
        currentPattern = Math.random() > 0.5 ? 'sine' : 'zigzag';
        document.getElementById('puzzle-text').innerText = 
            currentPattern === 'sine' ? "ë¬¼ê²°ì„ ë”°ë¼ ë¯¸ì„¸ìš”" : "ì§€ê·¸ì¬ê·¸ë¥¼ ë”°ë¼ ë¯¸ì„¸ìš”";

        drawWave();
        window.addEventListener('resize', drawWave);
        
        waveKnob.addEventListener('mousedown', startDrag);
        waveKnob.addEventListener('touchstart', startDrag, {passive: false});
        window.addEventListener('mousemove', onDrag);
        window.addEventListener('touchmove', onDrag, {passive: false});
        window.addEventListener('mouseup', endDrag);
        window.addEventListener('touchend', endDrag);
    }

    // Y ì¢Œí‘œ ê³„ì‚° í•¨ìˆ˜ (íŒ¨í„´ë³„)
    function calculateY(x, width, height) {
        const amplitude = 18; // êµ´ê³¡ ë†’ì´
        const frequency = 2.5; // ë°˜ë³µ íšŸìˆ˜
        const centerY = height / 2;
        const normalizedX = (x / width) * Math.PI * 2 * frequency;

        if (currentPattern === 'sine') {
            // Sine Wave (ë¶€ë“œëŸ¬ìš´ ë¬¼ê²°)
            return centerY + amplitude * Math.sin(normalizedX);
        } else {
            // Zigzag (Triangle Wave): (2/PI) * asin(sin(x)) ê³µì‹ì„ í™œìš©
            // Math.asin(Math.sin(normalizedX))ì˜ ê²°ê³¼ëŠ” -PI/2 ~ PI/2 ì‚¬ì´ì˜ ì§ì„  ë°˜ë³µ
            // ì—¬ê¸°ì— (2 / Math.PI)ë¥¼ ê³±í•˜ë©´ -1 ~ 1 ì‚¬ì´ì˜ ì§ì„  ë°˜ë³µì´ ë¨
            return centerY + amplitude * (2 / Math.PI) * Math.asin(Math.sin(normalizedX));
        }
    }

    // SVG ê·¸ë¦¬ê¸°
    function drawWave() {
        const width = waveContainer.clientWidth;
        const height = waveContainer.clientHeight;
        
        let pathData = `M 0 ${calculateY(0, width, height)}`;
        for (let x = 1; x <= width; x++) {
            pathData += ` L ${x} ${calculateY(x, width, height)}`;
        }
        wavePath.setAttribute('d', pathData);
        
        if(!isDragging) updateKnobPosition(0);
    }

    function startDrag(e) {
        isDragging = true;
        e.preventDefault();
    }

    function onDrag(e) {
        if (!isDragging) return;
        
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const rect = waveContainer.getBoundingClientRect();
        let x = clientX - rect.left;

        const width = rect.width;
        if (x < 0) x = 0;
        if (x > width - 44) x = width - 44; // ë…¸ë¸Œ í¬ê¸° 44px ê³ ë ¤

        updateKnobPosition(x);
        
        if (x >= width - 50) {
            isDragging = false;
            unlockPuzzle();
        }
    }

    function updateKnobPosition(x) {
        const width = waveContainer.clientWidth;
        const height = waveContainer.clientHeight;
        
        // ë…¸ë¸Œ ì¤‘ì‹¬ì  X ì¢Œí‘œ
        const centerX = x + 22; 
        const centerY = calculateY(centerX, width, height);
        
        // ë…¸ë¸ŒëŠ” top-left ê¸°ì¤€ì´ë¯€ë¡œ ë°˜ì§€ë¦„(22)ë§Œí¼ ë¹¼ì¤Œ
        waveKnob.style.left = `${x}px`;
        waveKnob.style.top = `${centerY - 22}px`;
    }

    function endDrag() {
        if (!isDragging) return;
        isDragging = false;
        waveKnob.style.transition = 'all 0.3s ease';
        updateKnobPosition(0);
        setTimeout(() => { waveKnob.style.transition = ''; }, 300);
    }

    function unlockPuzzle() {
        waveKnob.style.background = '#28a745';
        waveKnob.innerHTML = 'ğŸ”“';
        setTimeout(() => {
            failCount = 0;
            document.getElementById('puzzle-area').style.display = 'none';
            document.getElementById('login-form-area').style.display = 'block';
            document.getElementById('login-title').innerText = "ê´€ë¦¬ì ì ‘ì†";
            document.getElementById('fail-msg').style.display = 'none';
            document.getElementById('password-input').focus();
            
            waveKnob.style.background = '#007bff';
            updateKnobPosition(0);
        }, 500);
    }

    /* -----------------------------------------------------------
       ğŸ“ 2. ì—ë””í„° ë¡œì§ (ê¸°ì¡´ ë™ì¼)
    ----------------------------------------------------------- */
    let db = [];
    let currentTargetId = '';
    
    function triggerUpload(id) { currentTargetId = id; document.getElementById('gh-upload-input').click(); }
    
    async function handleGithubUpload(event) {
        const file = event.target.files[0];
        const token = document.getElementById('gh-token').value;
        const repo = document.getElementById('gh-repo').value;
        if (!file || !token || !repo) { alert("GitHub ì •ë³´ í•„ìš”"); return; }
        
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const content = reader.result.split(',')[1];
            const url = `https://api.github.com/repos/${repo}/contents/images/${file.name}`;
            try {
                let sha = null;
                const check = await fetch(url, { headers: {'Authorization': `token ${token}`} });
                if (check.ok) {
                    if(!confirm("ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?")) { event.target.value=''; return; }
                    sha = (await check.json()).sha;
                }
                const res = await fetch(url, {
                    method: 'PUT',
                    headers: {'Authorization': `token ${token}`, 'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: 'upload', content: content, sha: sha })
                });
                if(res.ok) {
                    document.getElementById(currentTargetId).value = `./images/${file.name}`;
                    alert("ì—…ë¡œë“œ ì™„ë£Œ");
                } else alert("ì—…ë¡œë“œ ì‹¤íŒ¨");
            } catch(e) { alert("ì—ëŸ¬: "+e); }
            event.target.value = '';
        }
    }

    function loadJSONFile(e) {
        const r = new FileReader();
        r.onload = (evt) => {
            try { db = JSON.parse(evt.target.result); updateSelector(); updateDisplay(); alert("ë¡œë“œë¨"); }
            catch { alert("JSON ì˜¤ë¥˜"); }
        };
        if(e.target.files[0]) r.readAsText(e.target.files[0]);
    }

    function updateSelector() {
        const s = document.getElementById('edit-selector');
        s.innerHTML = '<option value="">-- ì„ íƒ --</option>';
        db.sort((a,b)=>a.id-b.id).forEach(i => {
            const o = document.createElement('option');
            o.value = i.id; o.text = `${i.id}. ${i.question.substr(0,10)}...`;
            s.appendChild(o);
        });
    }

    function fillForm(id) {
        if(!id) { resetForm(false); return; }
        const item = db.find(x=>x.id==id);
        if(!item) return;
        ['id','ref','imgTop','imgBottom','q','pTop','pBottom','expImg','exp'].forEach(k => {
            let key = k;
            if(k=='pTop') key = item.passageTop ? 'passageTop' : 'passage';
            if(k=='ref') key = 'refInstruction';
            if(k=='q') key = 'question';
            if(k=='exp') key = 'explanation';
            if(k=='expImg') key = 'explanationImg';
            document.getElementById('inp-'+k).value = item[key] || "";
        });
        document.getElementById('inp-ans').value = item.answer;
        const opts = document.querySelectorAll('.opt');
        if(item.options) item.options.forEach((v,i) => { if(opts[i]) opts[i].value=v; });
    }

    function addItem() {
        const idVal = document.getElementById('inp-id').value;
        if(!idVal) { alert("ID í•„ìˆ˜"); return; }
        const item = {
            id: parseInt(idVal),
            refInstruction: document.getElementById('inp-ref').value || undefined,
            imgTop: document.getElementById('inp-imgTop').value || undefined,
            imgBottom: document.getElementById('inp-imgBottom').value || undefined,
            passageTop: document.getElementById('inp-pTop').value || undefined,
            passageBottom: document.getElementById('inp-pBottom').value || undefined,
            question: document.getElementById('inp-q').value,
            options: Array.from(document.querySelectorAll('.opt')).map(i=>i.value),
            answer: parseInt(document.getElementById('inp-ans').value),
            explanationImg: document.getElementById('inp-expImg').value || undefined,
            explanation: document.getElementById('inp-exp').value || ""
        };
        Object.keys(item).forEach(k => (item[k]===undefined || item[k]==="") && delete item[k]);
        const idx = db.findIndex(x=>x.id===item.id);
        if(idx>-1) db[idx]=item; else db.push(item);
        updateSelector(); updateDisplay(); alert("ì €ì¥ë¨");
    }

    function resetForm(c=true) {
        if(c && !confirm("ì´ˆê¸°í™”?")) return;
        document.querySelectorAll('input:not(#gh-token):not(#gh-repo), textarea').forEach(i=>i.value='');
        document.getElementById('inp-ans').value=0;
        document.getElementById('edit-selector').value="";
    }

    function downloadJSONFile() {
        if(!db.length) return alert("ë°ì´í„° ì—†ìŒ");
        const blob = new Blob([JSON.stringify(db,null,4)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download='qnas.json';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    function updateDisplay(){ document.getElementById('json-output').innerText = JSON.stringify(db,null,4); }
    function exportJSON(){ navigator.clipboard.writeText(JSON.stringify(db,null,4)); alert("ë³µì‚¬ë¨"); }
</script>
</body>
</html>
