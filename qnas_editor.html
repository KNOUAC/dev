<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiz Editor v6.2 (Puzzle Security)</title>
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        body { 
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif; 
            line-height: 1.6; 
            background: #f0f2f5; 
            margin: 0; 
            padding: 0;
            color: #333;
            -webkit-font-smoothing: antialiased;
        }
        
        * { box-sizing: border-box; }

        /* --- ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ --- */
        #main-app { display: none; opacity: 0; transition: opacity 0.5s ease; padding: 15px; }
        .container { 
            max-width: 950px; 
            margin: 0 auto; 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
        }
        
        h2 { 
            border-bottom: 2px solid #007bff; 
            padding-bottom: 12px; 
            margin-top: 0;
            color: #333; 
            font-size: 1.5rem;
        }

        /* --- ì…ë ¥ í•„ë“œ ê³µí†µ --- */
        label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.95em; color: #444; }
        input[type="text"], input[type="number"], input[type="password"], textarea, select { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            font-size: 16px; 
            transition: border-color 0.2s;
            background: #fff;
        }
        input:focus, textarea:focus, select:focus { border-color: #007bff; outline: none; }
        textarea { min-height: 100px; font-family: 'Consolas', monospace; resize: vertical; }

        /* --- ì„¤ì • ë°” --- */
        .config-bar { 
            background: #343a40; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; 
            display: flex; flex-wrap: wrap; gap: 12px; align-items: center; font-size: 0.9em; 
        }
        .config-bar span { white-space: nowrap; }
        .config-bar input { width: auto; flex-grow: 1; min-width: 150px; border: none; background: #4b545c; color: white; }
        .config-bar input::placeholder { color: #aaa; }

        /* --- ìƒë‹¨ íˆ´ë°” --- */
        .top-bar { 
            background: #e7f1ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; 
            display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
        }
        .top-bar button { flex-shrink: 0; }
        .top-bar select { flex-grow: 1; min-width: 200px; }

        /* --- í¼ ê·¸ë¦¬ë“œ --- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .full-width { grid-column: span 2; }
        .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f8f9fa; padding: 15px; border-radius: 8px; }

        .img-upload-group { display: flex; gap: 8px; width: 100%; }
        .img-upload-group input { flex-grow: 1; }
        .btn-upload { background: #17a2b8; color: white; border: none; padding: 0 15px; border-radius: 6px; cursor: pointer; white-space: nowrap; font-weight: 600; }

        /* --- ë²„íŠ¼ ê·¸ë£¹ --- */
        .btn-group { margin-top: 30px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        button { padding: 14px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; transition: 0.2s; }
        .btn-save { background: #28a745; color: white; } .btn-save:hover { background: #218838; }
        .btn-json { background: #007bff; color: white; } .btn-json:hover { background: #0069d9; }
        .btn-download { background: #6610f2; color: white; } .btn-download:hover { background: #520dc2; }
        .btn-clear { background: #6c757d; color: white; } .btn-clear:hover { background: #5a6268; }
        
        #json-output { margin-top: 25px; background: #2d2d2d; color: #ccc; padding: 15px; border-radius: 8px; white-space: pre-wrap; font-family: 'Consolas', monospace; max-height: 200px; overflow-y: auto; font-size: 0.85em; }

        /* --- ğŸ”’ ì ê¸ˆ í™”ë©´ & í¼ì¦ --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f0f2f5; display: flex; justify-content: center; align-items: center;
            z-index: 9999; padding: 20px;
        }
        .login-card {
            background: white; padding: 40px 30px; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; width: 100%; max-width: 360px;
            animation: fadeIn 0.5s ease-out; position: relative; overflow: hidden;
        }
        .login-icon { font-size: 45px; margin-bottom: 15px; display: block; }
        .login-title { font-size: 1.4rem; font-weight: 800; color: #333; margin-bottom: 25px; }
        
        /* í¼ì¦ ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ */
        #puzzle-area { display: none; margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px dashed #ccc; }
        .slider-wrapper { width: 100%; position: relative; margin-top: 15px; }
        input[type="range"].puzzle-slider {
            -webkit-appearance: none; width: 100%; height: 40px; border-radius: 20px;
            background: linear-gradient(90deg, #e9ecef 0%, #e9ecef 100%); outline: none; border: 2px solid #ddd;
        }
        input[type="range"].puzzle-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 40px; height: 36px; border-radius: 50%; background: #007bff;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='20px' height='20px'%3E%3Cpath d='M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: center;
        }
        .puzzle-text { font-size: 0.9em; color: #666; margin-bottom: 5px; font-weight: bold; }
        .fail-msg { color: #dc3545; font-size: 0.85em; margin-top: 10px; display: none; font-weight: bold; }

        .btn-login {
            width: 100%; padding: 14px; border: none; border-radius: 8px;
            background: #007bff; color: white; font-size: 16px; font-weight: bold;
            cursor: pointer; margin-top: 10px;
        }

        /* --- ëª¨ë°”ì¼ ë¯¸ë””ì–´ ì¿¼ë¦¬ --- */
        @media (max-width: 768px) {
            .container { padding: 15px; width: 100%; border-radius: 0; box-shadow: none; }
            #main-app { padding: 0; }
            .form-grid { grid-template-columns: 1fr; gap: 15px; }
            .full-width { grid-column: span 1; }
            .opt-grid { grid-template-columns: 1fr; }
            .btn-group { grid-template-columns: 1fr 1fr; }
            .config-bar span.note { display: none; }
            .img-upload-group { flex-direction: row; }
            .form-group .img-upload-group[style*="width: 50%"] { width: 100% !important; }
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
        .shake { animation: shake 0.3s; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-card" id="login-card">
        <span class="login-icon">ğŸ”’</span>
        <div class="login-title" id="login-title">ê´€ë¦¬ì ëª¨ë“œ</div>
        
        <div id="login-form-area">
            <input type="password" id="password-input" placeholder="ë¹„ë°€ë²ˆí˜¸" style="text-align:center; margin-bottom:15px;" onkeypress="handleEnter(event)">
            <button class="btn-login" onclick="checkPassword()">ì ‘ì†</button>
            <div id="fail-msg" class="fail-msg">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤ (0/5)</div>
        </div>

        <div id="puzzle-area">
            <div class="puzzle-text">ì ê¸ˆ í•´ì œí•˜ë ¤ë©´ ëê¹Œì§€ ë¯¸ì„¸ìš”</div>
            <div class="slider-wrapper">
                <input type="range" min="0" max="100" value="0" class="puzzle-slider" id="puzzle-slider" oninput="checkPuzzle(this)">
            </div>
            <div style="font-size:0.8em; color:#888; margin-top:10px;">ë„ˆë¬´ ë§ì€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>
        </div>
    </div>
</div>

<div id="main-app">
    <div class="container">
        <h2>ğŸ§© Quiz Editor v6.2</h2>
        
        <div class="config-bar">
            <span>ğŸ”‘ GitHub:</span> <input type="password" id="gh-token" placeholder="Token">
            <span>ğŸ“‚ Repo:</span> <input type="text" id="gh-repo" placeholder="User/Repo">
        </div>

        <div class="top-bar">
            <button onclick="document.getElementById('file-input').click()" style="background:#6f42c1; color:white; padding:10px 15px;">JSON ë¡œë“œ</button>
            <input type="file" id="file-input" accept=".json" style="display:none" onchange="loadJSONFile(event)">
            <select id="edit-selector" onchange="fillForm(this.value)">
                <option value="">-- ìˆ˜ì •í•  ë¬¸í•­ ì„ íƒ --</option>
            </select>
        </div>

        <div class="form-grid">
            <div class="form-group"><label>ë¬¸í•­ ë²ˆí˜¸ (ID)</label><input type="number" id="inp-id" placeholder="ìˆ«ìë§Œ ì…ë ¥"></div>
            <div class="form-group"><label>ì°¸ì¡° ì•ˆë‚´ë¬¸ (Instruction)</label><input type="text" id="inp-ref" placeholder="ì˜ˆ: ë‹¤ìŒ ê¸€ì„ ì½ê³ ..."></div>
            <div class="form-group">
                <label>ìƒë‹¨ ì´ë¯¸ì§€ (imgTop)</label>
                <div class="img-upload-group">
                    <input type="text" id="inp-imgTop" placeholder="./images/a.png">
                    <button class="btn-upload" onclick="triggerUpload('inp-imgTop')">UP</button>
                </div>
            </div>
            <div class="form-group">
                <label>í•˜ë‹¨ ì´ë¯¸ì§€ (imgBottom)</label>
                <div class="img-upload-group">
                    <input type="text" id="inp-imgBottom" placeholder="./images/b.png">
                    <button class="btn-upload" onclick="triggerUpload('inp-imgBottom')">UP</button>
                </div>
            </div>
            <div class="form-group full-width"><label>ì§ˆë¬¸ (Question)</label><input type="text" id="inp-q"></div>
            <div class="form-group full-width">
                <label>ìƒë‹¨ ì§€ë¬¸ (Passage Top)</label>
                <textarea id="inp-pTop" placeholder="ì§ˆë¬¸ ìœ„ìª½ ì§€ë¬¸"></textarea>
            </div>
            <div class="form-group full-width">
                <label>í•˜ë‹¨ ì§€ë¬¸ (Passage Bottom)</label>
                <textarea id="inp-pBottom" placeholder="ë³´ê¸° ìœ„ìª½ ì§€ë¬¸"></textarea>
            </div>
            <div class="full-width">
                <label style="margin-bottom:8px;">ë³´ê¸° ë° ì •ë‹µ</label>
                <div class="opt-grid">
                    <input type="text" class="opt" placeholder="ë³´ê¸° 1">
                    <input type="text" class="opt" placeholder="ë³´ê¸° 2">
                    <input type="text" class="opt" placeholder="ë³´ê¸° 3">
                    <input type="text" class="opt" placeholder="ë³´ê¸° 4">
                </div>
                <select id="inp-ans" style="margin-top:10px;"><option value="0">ì •ë‹µ: 1ë²ˆ</option><option value="1">ì •ë‹µ: 2ë²ˆ</option><option value="2">ì •ë‹µ: 3ë²ˆ</option><option value="3">ì •ë‹µ: 4ë²ˆ</option></select>
            </div>
            <div class="form-group full-width">
                <label>í•´ì„¤ (Explanation)</label>
                <div class="img-upload-group" style="width: 50%; margin-bottom:8px;">
                    <input type="text" id="inp-expImg" placeholder="í•´ì„¤ ì´ë¯¸ì§€ ê²½ë¡œ">
                    <button class="btn-upload" onclick="triggerUpload('inp-expImg')">UP</button>
                </div>
                <textarea id="inp-exp" style="height: 80px;" placeholder="í•´ì„¤ í…ìŠ¤íŠ¸"></textarea>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn-save" onclick="addItem()">ì €ì¥/ì¶”ê°€</button>
            <button class="btn-download" onclick="downloadJSONFile()">íŒŒì¼ ë°›ê¸°</button>
            <button class="btn-json" onclick="exportJSON()">JSON ë³µì‚¬</button>
            <button class="btn-clear" onclick="resetForm()">ì´ˆê¸°í™”</button>
        </div>
        <div id="json-output">// ê²°ê³¼ JSON ë¯¸ë¦¬ë³´ê¸°</div>
        <input type="file" id="gh-upload-input" style="display:none" onchange="handleGithubUpload(event)">
    </div>
</div>

<script>
    // ğŸ” ë³´ì•ˆ ë¡œì§ (ë¹„ë°€ë²ˆí˜¸ + í¼ì¦)
    const ACCESS_PASSWORD = "0070#";
    let failCount = 0;
    const MAX_FAIL = 5;

    function checkPassword() {
        const input = document.getElementById('password-input');
        const overlay = document.getElementById('login-overlay');
        const app = document.getElementById('main-app');
        const card = document.getElementById('login-card');
        const failMsg = document.getElementById('fail-msg');

        if (input.value === ACCESS_PASSWORD) {
            // ì„±ê³µ
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
                app.style.display = 'block';
                setTimeout(() => { app.style.opacity = '1'; }, 50);
            }, 300);
        } else {
            // ì‹¤íŒ¨
            failCount++;
            card.classList.add('shake');
            input.style.borderColor = '#dc3545';
            failMsg.style.display = 'block';
            failMsg.innerText = `ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤ (${failCount}/${MAX_FAIL})`;

            if (failCount >= MAX_FAIL) {
                // 5íšŒ ì´ìƒ ì‹¤íŒ¨ ì‹œ í¼ì¦ ëª¨ë“œ ì§„ì…
                document.getElementById('login-form-area').style.display = 'none';
                document.getElementById('puzzle-area').style.display = 'block';
                document.getElementById('login-title').innerText = "ë³´ì•ˆ í™•ì¸";
                document.getElementById('puzzle-slider').value = 0; // ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
            }

            setTimeout(() => {
                card.classList.remove('shake');
                input.style.borderColor = '#ddd';
                input.value = '';
                if(failCount < MAX_FAIL) input.focus();
            }, 300);
        }
    }

    // í¼ì¦ ìŠ¬ë¼ì´ë” ì²´í¬ í•¨ìˆ˜
    function checkPuzzle(slider) {
        if (parseInt(slider.value) === 100) {
            // í¼ì¦ ì„±ê³µ -> ë‹¤ì‹œ ë¡œê·¸ì¸ ê¸°íšŒ ë¶€ì—¬
            setTimeout(() => {
                failCount = 0; // ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
                document.getElementById('puzzle-area').style.display = 'none';
                document.getElementById('login-form-area').style.display = 'block';
                document.getElementById('login-title').innerText = "ê´€ë¦¬ì ëª¨ë“œ";
                document.getElementById('fail-msg').style.display = 'none';
                document.getElementById('password-input').focus();
            }, 300);
        }
    }

    function handleEnter(e) { if (e.key === 'Enter') checkPassword(); }

    // --- ì—ë””í„° ë¡œì§ (ê¸°ì¡´ ìœ ì§€) ---
    let db = [];
    let currentTargetId = '';

    function triggerUpload(targetId) {
        currentTargetId = targetId;
        document.getElementById('gh-upload-input').click();
    }

    async function handleGithubUpload(event) {
        const file = event.target.files[0];
        const token = document.getElementById('gh-token').value;
        const repo = document.getElementById('gh-repo').value;
    
        if (!file || !token || !repo) {
            alert("GitHub í† í°ê³¼ ì €ì¥ì†Œ ì •ë³´ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
    
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const base64Content = reader.result.split(',')[1];
            const fileName = file.name;
            const url = `https://api.github.com/repos/${repo}/contents/images/${fileName}`;
            let sha = null;
    
            try {
                const checkRes = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
                if (checkRes.ok) {
                    const fileData = await checkRes.json();
                    sha = fileData.sha;
                    if (!confirm(`íŒŒì¼ëª… ì¤‘ë³µ: '${fileName}'\në®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        event.target.value = ''; return;
                    }
                }
                const payload = {
                    message: sha ? `Update ${fileName}` : `Upload ${fileName}`,
                    content: base64Content,
                    sha: sha || undefined
                };
    
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
    
                if (response.ok) {
                    document.getElementById(currentTargetId).value = `./images/${fileName}`;
                    alert("ì—…ë¡œë“œ ì„±ê³µ!");
                } else {
                    const error = await response.json();
                    alert("ì‹¤íŒ¨: " + error.message);
                }
            } catch (err) { alert("ì˜¤ë¥˜: " + err.message); } 
            finally { event.target.value = ''; }
        };
    }

    function loadJSONFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                db = JSON.parse(e.target.result);
                updateSelector(); updateDisplay();
                alert("ë¡œë“œ ì™„ë£Œ");
            } catch (err) { alert("JSON í˜•ì‹ ì˜¤ë¥˜!"); }
            finally { event.target.value = ''; }
        };
        reader.readAsText(file);
    }

    function updateSelector() {
        const selector = document.getElementById('edit-selector');
        selector.innerHTML = '<option value="">-- ìˆ˜ì •í•  ë¬¸í•­ ì„ íƒ --</option>';
        db.sort((a,b) => a.id - b.id).forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.id;
            opt.innerText = `${item.id}. ${item.question.substring(0,15)}...`;
            selector.appendChild(opt);
        });
    }

    function fillForm(selectedId) {
        if (!selectedId) { resetForm(false); return; } 
        const item = db.find(x => x.id == selectedId);
        if (!item) return;
        document.getElementById('inp-id').value = item.id;
        document.getElementById('inp-ref').value = item.refInstruction || "";
        document.getElementById('inp-imgTop').value = item.imgTop || "";
        document.getElementById('inp-imgBottom').value = item.imgBottom || "";
        document.getElementById('inp-q').value = item.question || "";
        document.getElementById('inp-pTop').value = item.passageTop || item.passage || "";
        document.getElementById('inp-pBottom').value = item.passageBottom || "";
        document.getElementById('inp-ans').value = item.answer;
        document.getElementById('inp-expImg').value = item.explanationImg || "";
        document.getElementById('inp-exp').value = item.explanation || "";
        const opts = document.querySelectorAll('.opt');
        item.options.forEach((val, idx) => { if (opts[idx]) opts[idx].value = val; });
    }

    function addItem() {
        const idVal = document.getElementById('inp-id').value;
        if(!idVal) { alert("ë¬¸í•­ ë²ˆí˜¸(ID)ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }

        const item = {
            id: parseInt(idVal),
            refInstruction: document.getElementById('inp-ref').value || undefined,
            imgTop: document.getElementById('inp-imgTop').value || undefined,
            imgBottom: document.getElementById('inp-imgBottom').value || undefined,
            passageTop: document.getElementById('inp-pTop').value || undefined,
            passageBottom: document.getElementById('inp-pBottom').value || undefined,
            question: document.getElementById('inp-q').value,
            options: Array.from(document.querySelectorAll('.opt')).map(i => i.value),
            answer: parseInt(document.getElementById('inp-ans').value),
            explanationImg: document.getElementById('inp-expImg').value || undefined,
            explanation: document.getElementById('inp-exp').value || ""
        };
        
        // undefined ì •ë¦¬
        Object.keys(item).forEach(key => (item[key] === undefined || item[key] === "") && delete item[key]);
        
        const idx = db.findIndex(x => x.id === item.id);
        if(idx > -1) db[idx] = item; else db.push(item);
        
        updateSelector(); updateDisplay();
        alert("ì €ì¥ë¨ (ID: " + item.id + ")");
    }

    function resetForm(askConfirm = true) {
        if(askConfirm && !confirm("ì…ë ¥ë€ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const ids = ['inp-id', 'inp-ref', 'inp-imgTop', 'inp-imgBottom', 'inp-q', 'inp-pTop', 'inp-pBottom', 'inp-expImg', 'inp-exp'];
        ids.forEach(id => document.getElementById(id).value = '');
        document.querySelectorAll('.opt').forEach(opt => opt.value = '');
        document.getElementById('inp-ans').value = 0;
        document.getElementById('edit-selector').value = ""; 
    }

    function downloadJSONFile() {
        if (db.length === 0) { alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
        const dataStr = JSON.stringify(db, null, 4);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = "qnas.json";
        document.body.appendChild(a); a.click();
        document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    function updateDisplay() { document.getElementById('json-output').innerText = JSON.stringify(db, null, 4); }
    function exportJSON() {
        navigator.clipboard.writeText(JSON.stringify(db, null, 4)).then(() => alert("ë³µì‚¬ ì™„ë£Œ!"));
    }
</script>

</body>
</html>
