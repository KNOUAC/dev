<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë¬¸ì œ ë°ì´í„° JSON ì—ë””í„° v3 (ë¬¸í•­ ì„ íƒ ìˆ˜ì •)</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; line-height: 1.6; padding: 20px; background: #f0f2f5; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 10px; color: #333; }
        .section-title { font-weight: bold; color: #007bff; margin-top: 20px; margin-bottom: 10px; display: block; border-left: 4px solid #007bff; padding-left: 10px; }
        
        /* ë¬¸í•­ ì„ íƒ ë°” ìŠ¤íƒ€ì¼ */
        .select-bar { background: #e7f1ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
        .select-bar label { margin-bottom: 0; white-space: nowrap; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        textarea { height: 120px; font-family: 'Consolas', monospace; font-size: 0.9em; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f9f9f9; padding: 15px; border-radius: 6px; }
        .btn-group { margin-top: 30px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.2s; }
        .btn-save { background: #28a745; color: white; }
        .btn-json { background: #007bff; color: white; }
        .btn-load { background: #6f42c1; color: white; }
        .btn-clear { background: #6c757d; color: white; }
        #json-output { margin-top: 25px; background: #2d2d2d; color: #ccc; padding: 20px; border-radius: 8px; white-space: pre-wrap; font-family: 'Consolas', monospace; font-size: 0.85em; max-height: 400px; overflow-y: auto; }
        #file-input { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ§© ë¬¸ì œ ë°ì´í„° JSON ì—ë””í„° v3</h2>
    
    <div class="select-bar">
        <button class="btn-load" onclick="document.getElementById('file-input').click()">JSON íŒŒì¼ ë¡œë“œ</button>
        <input type="file" id="file-input" accept=".json" onchange="loadJSONFile(event)">
        
        <label>ğŸ“ ìˆ˜ì •í•  ë¬¸í•­ ì„ íƒ:</label>
        <select id="edit-selector" onchange="fillForm(this.value)">
            <option value="">-- ë¶ˆëŸ¬ì˜¨ ë¬¸í•­ ì—†ìŒ --</option>
        </select>
    </div>

    <div class="form-grid">
        <div class="form-group"><label>ë¬¸í•­ ë²ˆí˜¸ (ID)</label><input type="number" id="inp-id"></div>
        <div class="form-group"><label>ì°¸ì¡° ì•ˆë‚´ë¬¸ (refInstruction)</label><input type="text" id="inp-ref"></div>
        <div class="form-group"><label>ìƒë‹¨ ì´ë¯¸ì§€ (imgTop)</label><input type="text" id="inp-imgTop"></div>
        <div class="form-group"><label>í•˜ë‹¨ ì´ë¯¸ì§€ (imgBottom)</label><input type="text" id="inp-imgBottom"></div>
        <div class="form-group full-width"><label>ì§ˆë¬¸ (Question)</label><input type="text" id="inp-q"></div>
        <div class="form-group full-width"><label>ì§€ë¬¸ (Passage)</label><textarea id="inp-p"></textarea></div>

        <div class="full-width">
            <span class="section-title">ë³´ê¸° ë° ì •ë‹µ ì„¤ì •</span>
            <div class="options-grid">
                <input type="text" class="opt" placeholder="ë³´ê¸° 1">
                <input type="text" class="opt" placeholder="ë³´ê¸° 2">
                <input type="text" class="opt" placeholder="ë³´ê¸° 3">
                <input type="text" class="opt" placeholder="ë³´ê¸° 4">
                <select id="inp-ans">
                    <option value="0">ë³´ê¸° 1ë²ˆ ì •ë‹µ</option>
                    <option value="1">ë³´ê¸° 2ë²ˆ ì •ë‹µ</option>
                    <option value="2">ë³´ê¸° 3ë²ˆ ì •ë‹µ</option>
                    <option value="3">ë³´ê¸° 4ë²ˆ ì •ë‹µ</option>
                </select>
            </div>
        </div>

        <div class="form-group full-width">
            <span class="section-title">í•´ì„¤ ì„¤ì •</span>
            <label>í•´ì„¤ ì´ë¯¸ì§€ (explanationImg)</label><input type="text" id="inp-expImg">
            <label>í•´ì„¤ í…ìŠ¤íŠ¸ (explanation)</label><textarea id="inp-exp" style="height: 60px;"></textarea>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-save" onclick="addItem()">ë¬¸í•­ ì €ì¥ (ì¶”ê°€/ìˆ˜ì •)</button>
        <button class="btn-json" onclick="exportJSON()">JSON ì½”ë“œ ë³µì‚¬</button>
        <button class="btn-clear" onclick="resetForm()">ì…ë ¥ì°½ ë¹„ìš°ê¸°</button>
    </div>

    <div id="json-output">// ê²°ê³¼ JSONì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
</div>

<script>
    let db = [];

    function loadJSONFile(event) {
        const file = event.target.files[0];
        if (!file) return;
    
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const content = e.target.result;
                // JSON ë¬¸ë²• ê²€ì‚¬ ë° íŒŒì‹±
                const importedData = JSON.parse(content);
                
                if (Array.isArray(importedData)) {
                    db = importedData;
                    updateSelector();
                    updateDisplay();
                    alert(db.length + "ê°œì˜ ë¬¸í•­ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
                } else {
                    throw new Error("JSONì´ ë°°ì—´ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. [ { ... }, { ... } ] êµ¬ì¡°ì—¬ì•¼ í•©ë‹ˆë‹¤.");
                }
            } catch (err) {
                // ë¬¸ë²• ì˜¤ë¥˜ ì‹œ ìƒì„¸ ë‚´ìš© ì¶œë ¥
                console.error("JSON íŒŒì‹± ì—ëŸ¬:", err);
                alert("JSON íŒŒì¼ ì½ê¸° ì‹¤íŒ¨!\nì›ì¸: " + err.message + "\n\níŒ: ì‰¼í‘œ(,)ë‚˜ ë”°ì˜´í‘œ(\") ëˆ„ë½ì„ í™•ì¸í•˜ì„¸ìš”.");
            } finally {
                // [ì¤‘ìš”] ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ inputì˜ valueë¥¼ ì´ˆê¸°í™”í•˜ì—¬
                // ë™ì¼í•œ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•´ë„ change ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë„ë¡ í•¨
                event.target.value = '';
            }
        };
    
        reader.onerror = function() {
            alert("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ê¶Œí•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            event.target.value = '';
        };
    
        reader.readAsText(file);
    }

    // ë“œë¡­ë‹¤ìš´ ëª©ë¡ ê°±ì‹ 
    function updateSelector() {
        const selector = document.getElementById('edit-selector');
        selector.innerHTML = '<option value="">-- ë¬¸í•­ ì„ íƒ (ìˆ˜ì •ìš©) --</option>';
        
        // ID ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ í‘œì‹œ
        const sortedDb = [...db].sort((a, b) => a.id - b.id);
        
        sortedDb.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.id;
            opt.innerText = `ID: ${item.id} - ${item.question.substring(0, 20)}...`;
            selector.appendChild(opt);
        });
    }

    // ì„ íƒí•œ ë¬¸í•­ ë°ì´í„°ë¥¼ í¼ì— ì±„ìš°ê¸°
    function fillForm(selectedId) {
        if (!selectedId) { resetForm(); return; }
        
        const item = db.find(x => x.id == selectedId);
        if (!item) return;

        document.getElementById('inp-id').value = item.id;
        document.getElementById('inp-ref').value = item.refInstruction || "";
        document.getElementById('inp-imgTop').value = item.imgTop || "";
        document.getElementById('inp-imgBottom').value = item.imgBottom || "";
        document.getElementById('inp-q').value = item.question || "";
        document.getElementById('inp-p').value = item.passage || "";
        document.getElementById('inp-ans').value = item.answer;
        document.getElementById('inp-expImg').value = item.explanationImg || "";
        document.getElementById('inp-exp').value = item.explanation || "";

        const opts = document.querySelectorAll('.opt');
        item.options.forEach((val, idx) => {
            if (opts[idx]) opts[idx].value = val;
        });
    }

    function addItem() {
        const idVal = document.getElementById('inp-id').value;
        const qVal = document.getElementById('inp-q').value;
        if(!idVal || !qVal) { alert("IDì™€ ì§ˆë¬¸ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }

        const item = {
            id: parseInt(idVal),
            refInstruction: document.getElementById('inp-ref').value || undefined,
            imgTop: document.getElementById('inp-imgTop').value || undefined,
            imgBottom: document.getElementById('inp-imgBottom').value || undefined,
            passage: document.getElementById('inp-p').value || "",
            question: qVal,
            options: Array.from(document.querySelectorAll('.opt')).map(i => i.value),
            answer: parseInt(document.getElementById('inp-ans').value),
            explanationImg: document.getElementById('inp-expImg').value || undefined,
            explanation: document.getElementById('inp-exp').value || ""
        };

        Object.keys(item).forEach(key => (item[key] === undefined || item[key] === "") && delete item[key]);
        
        const existingIdx = db.findIndex(x => x.id === item.id);
        if(existingIdx > -1) {
            db[existingIdx] = item; // ìˆ˜ì •
        } else {
            db.push(item); // ì¶”ê°€
        }

        updateSelector();
        updateDisplay();
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function updateDisplay() {
        document.getElementById('json-output').innerText = JSON.stringify(db, null, 4);
    }

    function exportJSON() {
        const text = JSON.stringify(db, null, 4);
        navigator.clipboard.writeText(text).then(() => alert("JSON ë³µì‚¬ ì™„ë£Œ!"));
    }

    function resetForm() {
        document.querySelectorAll('input, textarea').forEach(i => i.value = '');
        document.getElementById('edit-selector').value = "";
    }
</script>

</body>
</html>
